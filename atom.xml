<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Xavier Riley <code>||=</code> Web Developer, Guildford]]></title>
  <link href="http://www.xavierriley.co.uk/atom.xml" rel="self"/>
  <link href="http://www.xavierriley.co.uk/"/>
  <updated>2012-10-16T14:10:52+01:00</updated>
  <id>http://www.xavierriley.co.uk/</id>
  <author>
    <name><![CDATA[]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Test driving Prestashop with Behat, Mink and Selenium - Step by step]]></title>
    <link href="http://www.xavierriley.co.uk/blog/2012/10/12/test-driving-prestashop-with-behat/"/>
    <updated>2012-10-12T00:00:00+01:00</updated>
    <id>http://www.xavierriley.co.uk/blog/2012/10/12/test-driving-prestashop-with-behat</id>
    <content type="html"><![CDATA[<p>Whilst I don&#8217;t do so much PHP development nowdays, I&#8217;ve been watching
the current rennaissance with interest. PHP is taking note of trends
being pushed by the Rails world with &#8220;clean and classy&#8221; frameworks such
as <a href="http://laravel.com/">Laravel</a> and best practice manifestos like <a href="http://www.phptherightway.com/">PHP the right
way</a> coming to light. This is all good
news for the web because better quality code (whatever language it&#8217;s
written in) raises the bar all round.</p>

<p>That said, there still seems to be a lack of good documentation
concerning proper Behaviour Driven Development (BDD) with PHP and it&#8217;s a
problem that we came across recently at <a href="http://kyan.com">Kyan</a>. I&#8217;m going to try and do a
walkthrough of setting up some simple fetaure testing using a default
install of the <a href="http://www.prestashop.com">Prestashop</a> ecommerce
framework. It&#8217;s a fairly sizeable project that doesn&#8217;t ship with test
coverage - let&#8217;s fix that!</p>

<h2>What you&#8217;ll need</h2>

<ul>
<li>A local install of <a href="http://www.prestashop.com">Prestashop</a></li>
<li><a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> (just the standard consumer version, not Aurora or nightly)</li>
<li><a href="http://selenium.googlecode.com/files/selenium-server-standalone-2.25.0.jar">Selenium RC (2.25.0 at the time of writing)</a></li>
<li><p>PHP 5.4 (just so we&#8217;re all on the same page)</p></li>
<li><p><a href="http://behat.org/">Behat (a PHP testing framework)</a></p></li>
<li><a href="http://mink.behat.org/">Mink (web acceptance testing for Behat)</a></li>
<li><a href="http://getcomposer.org/">Composer (a PHP packaging tool - think Bundler for PHP)</a></li>
</ul>


<p>&nbsp;</p>

<h3>1.) Install Prestashop</h3>

<p>Prestashop has a good set of instructions so I won&#8217;t duplicate them all
here. Suffice to say you need to set up a MySQL db and change a few
permissions.</p>

<h3>2.) Install Composer</h3>

<p>Make sure PHP is in your path. You can test this by firing up terminal
and typing</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php -v
</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;re using MAMP, put something like
this at the bottom of your <code>.bashrc</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/Applications/MAMP/bin/:$PATH&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Double check the path to the MAMP binaries. It&#8217;s different in different
versions of MAMP.</p>

<p>Now <code>cd</code> into your newly created prestashop folder and run the following
commands to install composer;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir bin
</span><span class='line'>curl -s https://getcomposer.org/installer | php -- --install-dir<span class="o">=</span>bin
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>If you&#8217;re installing using the default OSX apache and you get an error
about &#8220;detect_unicode = Off&#8221;, you&#8217;ll also need to
run the following;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo su
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;detect_unicode = Off&quot;</span> &gt;&gt; /private/etc/php.ini
</span><span class='line'>apachectl restart
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3.) Install Behat and Mink</h3>

<p>This part is the reason I&#8217;m writing this blog post. There seems to be a
lack of clear information about how to get these up and running from
scratch. Hopefully this will be sorted out as time goes on but I would
suggest people submit their points about what works and doesn&#8217;t work for
them.</p>

<p>To get started, make a file called <code>composer.json</code> in the root of the
Prestashop install and put in the following;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;behat/behat&quot;</span><span class="p">:</span>           <span class="s2">&quot;2.4@stable&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;behat/mink-extension&quot;</span><span class="p">:</span>  <span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;behat/mink-goutte-driver&quot;</span><span class="p">:</span>     <span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;behat/mink-selenium2-driver&quot;</span><span class="p">:</span>  <span class="s2">&quot;*&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;minimum-stability&quot;</span><span class="p">:</span> <span class="s2">&quot;dev&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;bin-dir&quot;</span><span class="p">:</span> <span class="s2">&quot;bin&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the equivalent of a Gemfile if you&#8217;ve used bundler and Ruby. So
to get everything up and running, run composer like so.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">php</span> <span class="err">bin/composer.phar</span> <span class="err">install</span>
</span></code></pre></td></tr></table></div></figure>


<p>All being, well you should see the packages installing into a vendor
folder in the project root.</p>

<h3>4.) Setting up Behat</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; bin/behat --init
</span><span class='line'>+d features - place your *.feature files here
</span><span class='line'>+d features/bootstrap - place bootstrap scripts and static files here
</span><span class='line'>+f features/bootstrap/FeatureContext.php - place your feature related code here
</span></code></pre></td></tr></table></div></figure>


<p>This bootstraps the files needed to run the tests. Let&#8217;s go ahead and
write our first test. Usually in test driven development, we write the
tests before the code, but I&#8217;m advocating here that we can add tests to
and exisiting site to give us the confidence to refactor and add
features later on. Start editing /features/basket.feature and put in
the following;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Feature:</span><span class="nf"> Basket</span>
</span><span class='line'><span class="nf">  In order to add a product to the basket</span>
</span><span class='line'><span class="nf">  As a website user</span>
</span><span class='line'><span class="nf">  I need to add the product to my basket</span>
</span><span class='line'><span class="nf">  And I should see the product in the basket </span>
</span><span class='line'>
</span><span class='line'><span class="nf">  @javascript</span>
</span><span class='line'><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Add a product to basket</span>
</span><span class='line'><span class="k">    Given </span><span class="nf">I am on a product page</span>
</span><span class='line'><span class="nf">    </span><span class="k">When </span><span class="nf">I click &quot;</span><span class="s">Add to cart</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    </span><span class="k">And </span><span class="nf">I hover over &quot;</span><span class="s">#shopping_cart a</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    </span><span class="k">Then </span><span class="nf">I should see the product title </span>
</span></code></pre></td></tr></table></div></figure>


<p>This is an example of a Cucumber test (the natural language syntax is
referred to as Gherkin) which is a popular way of doing acceptance
testing in Rails and other frameworks. We proceed by running the test
like so;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; bin/behat
</span><span class='line'>Feature: Basket
</span><span class='line'>  In order to add a product to the basket
</span><span class='line'>  As a website user
</span><span class='line'>  I need to add the product to my basket
</span><span class='line'>  And I should see the product in the basket
</span><span class='line'>
</span><span class='line'>  @javascript
</span><span class='line'>  Scenario: Add a product to basket     <span class="c"># features/basket.feature:8</span>
</span><span class='line'>    Given I am on a product page
</span><span class='line'>    When I click on <span class="s2">&quot;Add to cart&quot;</span>
</span><span class='line'>    And I hover over <span class="s2">&quot;#shopping_cart a&quot;</span>
</span><span class='line'>    Then I should see the product title
</span><span class='line'>
</span><span class='line'>1 scenario <span class="o">(</span>1 undefined<span class="o">)</span>
</span><span class='line'>4 steps <span class="o">(</span>4 undefined<span class="o">)</span>
</span><span class='line'>0m0.039s
</span><span class='line'>
</span><span class='line'>You can implement step definitions <span class="k">for </span>undefined steps with these snippets:
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * @Given /^I am on a product page<span class="nv">$/</span>
</span><span class='line'>     */
</span><span class='line'>    public <span class="k">function </span>iAmOnAProductPage<span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        throw new PendingException<span class="o">()</span>;
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * @When /^I click <span class="s2">&quot;([^&quot;</span><span class="o">]</span>*<span class="o">)</span><span class="s2">&quot;$/</span>
</span><span class='line'><span class="s2">     */</span>
</span><span class='line'><span class="s2">    public function iClick($arg1)</span>
</span><span class='line'><span class="s2">    {</span>
</span><span class='line'><span class="s2">        throw new PendingException();</span>
</span><span class='line'><span class="s2">    }</span>
</span><span class='line'>
</span><span class='line'><span class="s2">    /**</span>
</span><span class='line'><span class="s2">     * @Given /^I hover over &quot;</span><span class="o">([</span>^<span class="s2">&quot;]*)&quot;</span><span class="nv">$/</span>
</span><span class='line'>     */
</span><span class='line'>    public <span class="k">function </span>iHoverOver<span class="o">(</span><span class="nv">$arg1</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        throw new PendingException<span class="o">()</span>;
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    /**
</span><span class='line'>     * @Then /^I should see the product title<span class="nv">$/</span>
</span><span class='line'>     */
</span><span class='line'>    public <span class="k">function </span>iShouldSeeTheProductTitle<span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        throw new PendingException<span class="o">()</span>;
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This runs the test and tells you what to do next. Copy the snippets into
the <code>features/bootstrap/FeatureContext.php</code> file above the final
curly brace. After saving and running <code>bin/behat</code> again, the output should change to include</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>TODO: write pending definition
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>5.) Enable Mink</h3>

<p>This is where the documentation starts to part ways with the latest
versions of Mink and Behat. After struggling with the official run
through at <a href="http://mink.behat.org/">http://mink.behat.org/</a> trying to
get Zombie working as the Javascript client, I stumbled across the Mink
example repository in the Behat official Github page here
<a href="https://github.com/Behat/MinkExtension-example">https://github.com/Behat/MinkExtension-example</a></p>

<p>The key is swapping out <code>BehatContext</code> in the <code>FeaturesContext</code> file, to
make sure that it reads;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class FeatureContext extends Behat\MinkExtension\Context\MinkContext</span>
</span></code></pre></td></tr></table></div></figure>


<p>and then you need to configure Behat and Mink to be looking in the right
places and choosing the correct browser drivers. Make a file called
<code>behat.yml</code> in the root of the project with the following;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">context</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">class</span><span class="p-Indicator">:</span>  <span class="s">&#39;FeatureContext&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Behat\MinkExtension\Extension</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">base_url</span><span class="p-Indicator">:</span>  <span class="s">&#39;http://tdd.prestashopexample.com/&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">goutte</span><span class="p-Indicator">:</span>    <span class="l-Scalar-Plain">~</span>
</span><span class='line'>      <span class="l-Scalar-Plain">selenium2</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>goutte</code> seems to be a requirement as far as I can tell, but who
knows&#8230;</p>

<p>Now when you run <code>bin/behat</code> again, you should see an error like this;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">Curl error thrown for http POST to http://localhost:4444/wd/hub/session with params</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span><span class="s">&quot;desiredCapabilities&quot;</span><span class="p-Indicator">:{</span><span class="s">&quot;browserName&quot;</span><span class="p-Indicator">:</span><span class="s">&quot;firefox&quot;</span><span class="p-Indicator">,</span><span class="s">&quot;version&quot;</span><span class="p-Indicator">:</span><span class="s">&quot;8&quot;</span><span class="p-Indicator">,</span><span class="s">&quot;platform&quot;</span><span class="p-Indicator">:</span><span class="s">&quot;ANY&quot;</span><span class="p-Indicator">,</span><span class="s">&quot;browserVersion&quot;</span><span class="p-Indicator">:</span><span class="s">&quot;8&quot;</span><span class="p-Indicator">,</span><span class="s">&quot;browser&quot;</span><span class="p-Indicator">:</span><span class="s">&quot;firefox&quot;</span><span class="p-Indicator">},</span><span class="s">&quot;requiredCapabilities&quot;</span><span class="p-Indicator">:[]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enter Selenium&#8230;</p>

<h3>6.) Setting up selenium</h3>

<p>This should be quite straightforward. First off, make sure you have the
standard version of Firefox installed. Download Selenium RC from the link
at the top of the page and move the <code>.jar</code> file to the <code>vendor/</code> folder.
Then run the following command to start the Selenium server;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">java -jar vendor/selenium-server-standalone-2.25.0.jar &gt; /dev/null &amp;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should see <code>INFO: Launching a standalone server</code> and you&#8217;re good to
try the tests again by running <code>bin/behat</code>. This time you&#8217;ll see Firefox
start up, flash up with the page content and close again. The first test
passed! Now let&#8217;s implement the others.</p>

<h3>7.) Finishing the steps</h3>

<p>Change the methods in <code>FeatureContext.php</code> to look like this;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x"> * @Given /^I hover over &quot;([^&quot;]*)&quot;$/</span>
</span><span class='line'><span class="x"> */</span>
</span><span class='line'><span class="x">public function iHoverOver($arg1)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $this-&gt;getSession()-&gt;getPage()-&gt;find(&#39;css&#39;, $arg1)-&gt;mouseOver();</span>
</span><span class='line'><span class="x">    $this-&gt;getSession()-&gt;wait(5000, &quot;$(&#39;#cart_block_list&#39;).hasClass(&#39;expanded&#39;)&quot;);</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x"> * @Then /^I should see the product title$/</span>
</span><span class='line'><span class="x"> */</span>
</span><span class='line'><span class="x">public function iShouldSeeTheProductTitle()</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">    $product_title = $this-&gt;getSession()-&gt;getPage()-&gt;find(&#39;css&#39;, &#39;.cart_block_product_name&#39;);</span>
</span><span class='line'><span class="x">    $product_title == &quot;iPod Nano&quot;;</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few things to note here before we proceed - this isn&#8217;t a very robust
test and could be improved. There&#8217;s duplication all over the place which
could be refactored (but it&#8217;s late and I&#8217;ve just got it working&#8230;). The
real problem is that it&#8217;s assuming the title of the product as the
assertion in the last point. A better approch would be to call/mock the
product from Prestashop in the constructor and use that instead. Maybe
in part 2.</p>

<p>Also, it bugged me that the <code>wait-&gt;(...)</code> call which executes JS is
executed in the context of the session. It makes perfect sense in
hindsight as <code>getPage</code> is returning a sort of DOM object but it tripped
me up nonetheless.</p>

<p>Down to business - run <code>bin/behat</code> one last time and the output should
look like this;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; bin/behat                                                                                       1 ↵
</span><span class='line'>Feature: Basket
</span><span class='line'>  In order to add a product to the basket
</span><span class='line'>  As a website user
</span><span class='line'>  I need to add the product to my basket
</span><span class='line'>  And I should see the product in the basket
</span><span class='line'>
</span><span class='line'>  @javascript
</span><span class='line'>  Scenario: Add a product to basket     <span class="c"># features/basket.feature:8</span>
</span><span class='line'>    Given I am on a product page        <span class="c"># FeatureContext::iAmOnAProductPage()</span>
</span><span class='line'>    When I click on <span class="s2">&quot;Add to cart&quot;</span>       <span class="c"># FeatureContext::iClickOn()</span>
</span><span class='line'>    And I hover over <span class="s2">&quot;#shopping_cart a&quot;</span> <span class="c"># FeatureContext::iHoverOver()</span>
</span><span class='line'>    Then I should see the product title <span class="c"># FeatureContext::iShouldSeeTheProductTitle()</span>
</span><span class='line'>
</span><span class='line'>1 scenario <span class="o">(</span>1 passed<span class="o">)</span>
</span><span class='line'>4 steps <span class="o">(</span>4 passed<span class="o">)</span>
</span><span class='line'>0m4.056s
</span></code></pre></td></tr></table></div></figure>


<p>Happy days!</p>

<h2>Conclusion</h2>

<p>There&#8217;s a ton of PHP apps out there that would benefit from regression
tests like this. They&#8217;re not that hard to write once you get going and
they give you an invaluable safety net and peace of mind when it comes
to refactoring and adding new features.</p>

<p>My motivation for writing this was that the current state of documentation
seems a bit patchy, despite the Behat and Mink projects being well established.
I suppose this is a call to arms to PHP devs to try this stuff out
and get their feedback into the loop.</p>

<p>I&#8217;d love to see more advanced posts dealing with the various drivers
that are available and also to hear what people think of
this one. I&#8217;ll finish by saying I&#8217;m starting out on this trail so my advice
is only what I&#8217;ve managed to cobble together up to now. If there&#8217;s
improvements or suggestions in the comments I&#8217;ll happily fold them back in to
the main post. Happy testing&#8230;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Transferring Customers From Prestashop To Magento]]></title>
    <link href="http://www.xavierriley.co.uk/blog/2010/09/03/transferring-customers-from-prestashop-to-magento/"/>
    <updated>2010-09-03T00:00:00+01:00</updated>
    <id>http://www.xavierriley.co.uk/blog/2010/09/03/transferring-customers-from-prestashop-to-magento</id>
    <content type="html"><![CDATA[<p>There’s always debate about which ecommerce platform is harder/better/faster/stronger, and from experience of Prestashop and Magento I can say they’re both really good for different types of shops. For <a href="http::www.forsyths.co.uk/">Forsyths</a>, I developed a Prestashop solution for their Sheet Music department whilst I was working there and it’s been great so far but…</p>

<p><del>When picking a solution it really pays to do some forward planning and in this case, Prestashop can’t scale up to the kind of multi-store functionality that this music department store needed. That said, it was a lot easier getting a Prestashop store off the ground (I tried both at the start) and it’s served us well. My only gripe is that Prestashop’s module and templating system isn’t flexible enough to make real changes without editing the core – and that screws up future updates. Not what you need for ecommerce purposes.</del></p>

<p><em>UPDATE</em>
Since writing this, it&#8217;s all change with Prestashop v1.5
They&#8217;ve had a basic overrides system in place for a while now.
Also the new version supports multistore but I haven&#8217;t used it, yet&#8230;</p>

<p>** Making the switch</p>

<p>Swapping out the products from PS to Mage is pretty straightforward – it’s just a case of a mysql query which maps them into the right fields. As with any Magento import the process is more or less similar;</p>

<ul>
<li>Add some dummy data into Magento, using all the fields you’re likely to use</li>
<li>Export the data as a csv using System > Import/Export > Profiles</li>
<li>Look at the file in your var/export folder and take a look at the headers</li>
</ul>


<p>Tip for *nix users working with csv files – in terminal use the following command to save the first two lines to a file;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>head -n 2 your_csv_file.csv &gt; your_csv_file_head.csv
</span></code></pre></td></tr></table></div></figure>


<p>That’s if your csv file is really big.</p>

<p>** The problem with users</p>

<p>Now the above works fine for most things, but the problem with users lies in the different authentication that both shops use. Magento uses MD5 with a salt on the end, Prestashop uses a ‘Cookie Key’ prefix to the customer password, which is then MD5 encrypted.
Anyone who’s looked into MD5 knows that this is a pig – you can’t reverse an MD5 into plain text, therefore you can’t get the original password strings in order to re-encode them (which is actually a good thing…).</p>

<p>** How to fix it</p>

<p>Clearly its impossible to convert from one MD5 hash to another so we have to try something different. Make the following file;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>magentoroot<span class="o">)</span>/app/code/local/Mage/Customer/Model/Customer.php
</span></code></pre></td></tr></table></div></figure>


<p>and in it put the following;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">class Mage_Customer_Model_Customer extends Mage_Core_Model_Abstract</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'><span class="x">/**</span>
</span><span class='line'><span class="x">* Authenticate customer</span>
</span><span class='line'><span class="x">*</span>
</span><span class='line'><span class="x">* @param string $login</span>
</span><span class='line'><span class="x">* @param string $password</span>
</span><span class='line'><span class="x">* @return true</span>
</span><span class='line'><span class="x">* @throws Exception</span>
</span><span class='line'><span class="x">*/</span>
</span><span class='line'><span class="x">public function authenticate($login, $password)</span>
</span><span class='line'><span class="x">{</span>
</span><span class='line'>
</span><span class='line'><span class="x">$this-&gt;loadByEmail($login);</span>
</span><span class='line'><span class="x">if ($this-&gt;getConfirmation() &amp;&amp; $this-&gt;isConfirmationRequired()) {</span>
</span><span class='line'><span class="x">throw Mage::exception(&#39;Mage_Core&#39;, Mage::helper(&#39;customer&#39;)-&gt;__(&#39;This account is not confirmed.&#39;),</span>
</span><span class='line'><span class="x">self::EXCEPTION_EMAIL_NOT_CONFIRMED</span>
</span><span class='line'><span class="x">);</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">if (!$this-&gt;validatePassword($password) &amp;&amp; !$this-&gt;validatePassword(&#39;hKvthisisyourgibberishcookiestringfromprestashopCM&#39;.$password)) {</span>
</span><span class='line'><span class="x">throw Mage::exception(&#39;Mage_Core&#39;, Mage::helper(&#39;customer&#39;)-&gt;__(&#39;Invalid login or password.&#39;),</span>
</span><span class='line'><span class="x">self::EXCEPTION_INVALID_EMAIL_OR_PASSWORD</span>
</span><span class='line'><span class="x">);</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">Mage::dispatchEvent(&#39;customer_customer_authenticated&#39;, array(</span>
</span><span class='line'><span class="x">&#39;model&#39; =&gt; $this,</span>
</span><span class='line'><span class="x">&#39;password&#39; =&gt; $password,</span>
</span><span class='line'><span class="x">));</span>
</span><span class='line'><span class="x">return true;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">//end class</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the random string prepended to the password variable? That’s your cookie string which you’ll find in your Prestashop install here;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">(prestshop root)/config/settings.inc.php</span>
</span></code></pre></td></tr></table></div></figure>


<p>It’s the line beginning</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">define(&#39;_COOKIE_KEY_&#39;, &#39;ThisIsTheBitYouWant...&#39; </span>
</span></code></pre></td></tr></table></div></figure>


<p>Believe it or not that’s all you need to do. Import your MD5 hashes from Prestashop straight into Magento and it’ll authenticate them as Prestashop would do. I’ll go through the mysql import in another post.</p>
]]></content>
  </entry>
  
</feed>
